import"./index-7f83b671.js";import{C as V,s as I}from"./ChatComponent-d9ac92a2.js";import{_ as C,A as b,k as y}from"./VAvatar-26ba638e.js";import{V as g,a as S,c as k}from"./VCard-04090dfd.js";import{V as r}from"./VRow-dc63d6f3.js";import{V as c}from"./VCol-2a55624e.js";import{V as v}from"./VBtn-0a240091.js";import{a as N}from"./VTextField-ebe460cb.js";import{U as w,J as d,K as u,L as o,n as s,R as m,O as E,S as p,a6 as l,a7 as B,a8 as D}from"./index-bf525995.js";import"./index-cdd36948.js";const T={name:"BroadcastingVideo",components:{ChatComponent:V},data(){return{time:0,interval:null,canvas:document.getElementById("canvas"),photo:document.getElementById("photo"),streamName:"Прямая трансляция",viewers:0,started:!1,peerConnections:{},config:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]},socket:null,videoElement:document.querySelector("video"),audioSelect:document.querySelector("select#audioSource"),videoSelect:document.querySelector("select#videoSource"),room:{}}},computed:{user(){return this.$store.state.auth.user}},methods:{stopStreaming(){this.started=!1,this.viewers=0,this.socket.emit("end of stream",{streamName:this.streamName,roomName:this.user.username})},startStreaming(){this.started=!0,this.socket=I,this.socket.emit("create room",{streamName:this.streamName,roomName:this.user.username}),this.socket.on("answer",(e,t)=>{this.peerConnections[e].setRemoteDescription(t)}),this.socket.on("stream info",e=>{this.viewers=e.viewers}),this.socket.on("join room",e=>{const t=new RTCPeerConnection(this.config);this.peerConnections[e]=t;let a=this.videoElement.srcObject;a.getTracks().forEach(n=>t.addTrack(n,a)),t.onicecandidate=n=>{n.candidate&&this.socket.emit("icecandidate",e,n.candidate)},t.createOffer().then(n=>t.setLocalDescription(n)).then(()=>{this.socket.emit("offer",e,t.localDescription)})}),this.socket.on("icecandidate",(e,t)=>{this.peerConnections[e].addIceCandidate(new RTCIceCandidate(t))}),window.onunload=window.onbeforeunload=()=>{this.viewers=0,this.socket.emit("end of stream",{streamName:this.streamName,roomName:this.user.username}),this.socket.close(),this.peerConnection.close()},this.videoElement=document.querySelector("video"),this.audioSelect=document.querySelector("select#audioSource"),this.videoSelect=document.querySelector("select#videoSource"),this.audioSelect.onchange=this.getStream,this.videoSelect.onchange=this.getStream,this.getStream().then(this.getDevices).then(this.gotDevices)},getDevices(){return navigator.mediaDevices.enumerateDevices()},gotDevices(e){window.deviceInfos=e;for(const t of e){const a=document.createElement("option");a.value=t.deviceId,t.kind==="audioinput"?(a.text=t.label||`Microphone ${this.audioSelect.length+1}`,this.audioSelect.appendChild(a)):t.kind==="videoinput"&&(a.text=t.label||`Camera ${this.videoSelect.length+1}`,this.videoSelect.appendChild(a))}},getStream(){window.stream&&window.stream.getTracks().forEach(n=>{n.stop()});const e=this.audioSelect.value,t=this.videoSelect.value,a={audio:{deviceId:e?{exact:e}:void 0},video:{deviceId:t?{exact:t}:void 0}};return navigator.mediaDevices.getUserMedia(a).then(this.gotStream).catch(this.handleError)},gotStream(e){window.stream=e,this.audioSelect.selectedIndex=[...this.audioSelect.options].findIndex(t=>t.text===e.getAudioTracks()[0].label),this.videoSelect.selectedIndex=[...this.videoSelect.options].findIndex(t=>t.text===e.getVideoTracks()[0].label),this.videoElement.srcObject=e,this.socket.emit("broadcaster")},takePicture(){this.canvas=document.getElementById("canvas"),this.photo=document.getElementById("photo");const a=this.canvas.getContext("2d");{this.canvas.width=300,this.canvas.height=169,a.drawImage(this.videoElement,0,0,300,169);const n=this.canvas.toDataURL("image/png");this.socket.emit("set room preview",{roomName:this.user.username,image:n})}},handleError(e){console.error("Error: ",e)}}},f=e=>(B("data-v-db55b070"),e=e(),D(),e),R=f(()=>l("video",{playsinline:"",autoplay:"",muted:"",id:"video"},null,-1)),q={class:"red--text"},A=f(()=>l("section",{class:"select"},[l("label",{for:"audioSource"},"Источник аудио: "),l("select",{id:"audioSource"})],-1)),F=f(()=>l("section",{class:"select"},[l("label",{for:"videoSource"},"Источник видео: "),l("select",{id:"videoSource"})],-1)),O=f(()=>l("canvas",{id:"canvas"},null,-1));function U(e,t,a,n,i,h){const _=w("chat-component");return d(),u(r,{"no-gutters":""},{default:o(()=>[s(c,{cols:"8"},{default:o(()=>[s(g,{"max-width":"1200",class:"pa-2 ma-2"},{default:o(()=>[s(b,{"aspect-ratio":"16/9"},{default:o(()=>[s(S,null,{default:o(()=>[m(" Трансляция с веб-камеры ")]),_:1}),s(k,null,{default:o(()=>[s(r,null,{default:o(()=>[s(c,null,{default:o(()=>[R]),_:1})]),_:1}),s(r,null,{default:o(()=>[s(c,{cols:"auto"},{default:o(()=>[i.started?(d(),u(v,{key:1,onClick:h.stopStreaming,color:"#EF9A9A",text:"Завершить трансляцию"},null,8,["onClick"])):(d(),u(v,{key:0,onClick:h.startStreaming,color:"#80CBC4",text:"Начать трансляцию"},null,8,["onClick"]))]),_:1}),s(c,{cols:"auto"},{default:o(()=>[i.started?(d(),u(v,{key:0,onClick:h.takePicture,text:"Заставка"},null,8,["onClick"])):E("",!0)]),_:1}),i.started?(d(),u(c,{key:1,cols:"auto"},{default:o(()=>[m(p(i.streamName),1)]),_:1})):(d(),u(c,{key:0,cols:"3"},{default:o(()=>[s(N,{label:"Название трансляции",modelValue:i.streamName,"onUpdate:modelValue":t[0]||(t[0]=x=>i.streamName=x),solo:""},null,8,["modelValue"])]),_:1})),s(c,{cols:"auto"},{default:o(()=>[m(" Длительность трансляции: "+p(("0"+(i.time/3600>>0)).slice(-2))+":"+p(("0"+(i.time/60>>0)).slice(-2))+":"+p(("0"+Number(((i.time/60-(i.time/60>>0))*60).toFixed(0))).slice(-2)),1)]),_:1}),s(c,{cols:"auto"},{default:o(()=>[s(y,{color:"#F44336"},{default:o(()=>[m("mdi-account-outline")]),_:1}),m(),l("span",q,p(i.viewers),1)]),_:1})]),_:1}),s(r,null,{default:o(()=>[s(c,null,{default:o(()=>[s(r,null,{default:o(()=>[A]),_:1}),s(r,null,{default:o(()=>[F]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(c,{cols:"4"},{default:o(()=>[s(r,{"align-self":"right"},{default:o(()=>[s(g,{class:"pa-2 ma-2"},{default:o(()=>[s(S,null,{default:o(()=>[m(" Текущая заставка трансляции ")]),_:1}),s(k,null,{default:o(()=>[O]),_:1})]),_:1})]),_:1}),s(r,null,{default:o(()=>[s(_,{socket:i.socket,"room-name":h.user.username},null,8,["socket","room-name"])]),_:1})]),_:1})]),_:1})}const j=C(T,[["render",U],["__scopeId","data-v-db55b070"]]),L={components:{BroadcastingVideo:j},name:"broadcaster",computed:{loggedIn(){return this.$store.state.auth.status.loggedIn},user(){return this.$store.state.auth.user}},mounted(){this.loggedIn||this.$router.push("/login")}};function P(e,t,a,n,i,h){const _=w("broadcasting-video");return d(),u(r,null,{default:o(()=>[s(c,null,{default:o(()=>[s(_)]),_:1})]),_:1})}const Z=C(L,[["render",P]]);export{Z as default};
